angular.module("Dragtable",["RecursionHelper"]).directive("tableDraggable",["FilterService",function(e){return{link:function(t,a,n){a.attr("draggable",!0);var r=50,l=0,i=function(e){l=e.originalEvent.clientX-a.offset().left},o=!1,d='<div class="{elemClass}" style="height: {height}px; width: {width}px;"><h5 class="{elemTextClass}">{text}</h5></div>',s=function(e,t){for(var a in t)e=e.replace(new RegExp("{"+a+"}","g"),t[a]);return e},g=function(){return s(d,{elemClass:"ghost__th",elemTextClass:"ghost__th-text",height:a.outerHeight(),width:a.outerWidth(),text:""})},h=!1,f=function(){var e=a.index()+1;h=a.closest("table").find("tr").find("td:nth-child("+e+"):visible");var t="";h.addClass("ghost-data");var n=h.length;n>r&&(n=r);for(var l=0;l<n;l++)t+=s(d,{elemClass:"ghost__td",elemTextClass:"ghost__td-text",height:h[l].clientHeight,width:h[l].clientWidth,text:h[l].innerHTML});return t},u=function(e,t){var n='<div class="ghost pos-fix">'+e+t+"</div>";a.closest("table").before(n),o=$(".ghost");var r=a.offset();o.css("top",r.top),o.css("left",r.left)},c=function(e){a.addClass("dragging"),o&&o.remove(),i(e);var t=g(),n=f();u(t,n)},v=function(){angular.element(".ghost-placeholder").removeClass("ghost-placeholder").removeAttr("width"),angular.element(".ghost-data").removeClass("ghost-data")},m=!1;a.bind("mousedown",function(e){m=e.target}),a.bind("dragstart",function(r){return!a.hasClass("notdraggable")&&(!(n.handle&&!$(m).hasClass(n.handle)&&!$(m).closest("."+n.handle).length)&&(v(),a.addClass("ghost-placeholder").attr("width",a.outerWidth()),c(r),void e.SetStartIndex(t.key)))});var b=!1;a.bind("drag",function(e){return!a.hasClass("notdraggable")&&(clearTimeout(b),void(b=setTimeout(function(){o&&o.css("left",e.originalEvent.clientX-l)},2)))}),a.bind("dragstop dragend",function(e){o&&o.remove(),v(),m=!1})}}}]).directive("tableDroppable",["$rootScope","FilterService",function(e,t){return{link:function(a,n,r){var l=!1,i=50,o=function(e,t,a){var n=angular.element("th:nth-child("+t+")").last(),r=angular.element(".ghost-placeholder").last(),l=angular.element("tbody td:nth-child("+t+")"),o=angular.element(".ghost-data"),d=l.length;if(d>i&&(d=i),"right"===e){n.after(r);for(var s=0;s<d&&"undefined"!=typeof o[s];s++)l[s].after(o[s])}else if("left"===e){n.before(r);for(var g=0;g<d&&"undefined"!=typeof o[g];g++)l[g].before(o[g])}var h=angular.element(".th-placeholder").last(),f=angular.element(".th-aggregation");h.after(f);for(var u=h.index(),c=angular.element("tbody td:nth-child("+(u+1)+")"),v=angular.element(".td-aggregation"),m=0;m<d&&"undefined"!=typeof v[m];m++)c[m].after(v[m])};n.bind("dragover",function(e){return e.preventDefault(),!n.hasClass("notdraggable")&&(clearTimeout(l),void(l=setTimeout(function(){var t=e.originalEvent.x>n.offset().left+n.width()/2?"right":"left";o(t,n.index()+1)},20)))}),n.bind("drop dragend",function(a){if(a.preventDefault(),n.hasClass("notdraggable"))return!1;var r=t.GetStartIndex(),l=angular.element(".th-offset").length,i=angular.element(".ghost-placeholder").index()-l;if(r===i)return!1;var d=i>r?"left":"right";o(d,r+l+1,!0),e.ReorderFilters(r,i)})}}}]);