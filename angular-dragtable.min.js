angular.module("Dragtable",[]).directive("dragMe",[function(){return{link:function(e,t,n){t.attr("draggable",!0),n.handle&&t.find(n.handle)?t.find(n.handle).attr("style","cursor: e-resize;"):t.attr("style","cursor: e-resize;");var a,r,i=n.limit||50,o=0,l=!1,d=!1,s=!1,f='<div class="ghost" style="position: fixed;">{ghostHtml}</div>',h='<div class="{elemClass}" style="height: {height}px; width: {width}px;">{text}</div>';$(document).on("dragover",function(e){a=e.originalEvent.clientX,r=e.originalEvent.clientY});var g=function(e,t){for(var n in t)e=e.replace(new RegExp("{"+n+"}","g"),t[n]);return e},u=function(e){o=e.originalEvent.clientX-t.offset().left},c=function(e){s&&s.remove(),u(e),m(v())},v=function(){var e="",n=t.index()+1,a=t.closest("table").find("tr td:nth-child("+n+"):visible");a.addClass("ghost__data");var r=a.length;r>i&&(r=i);for(var o=0;o<r;o++){var l=$(a[o]);e+=g(h,{elemClass:"ghost__td",height:l.outerHeight(),width:l.outerWidth(),text:l.html()})}return e},m=function(e){t.closest("table").before(g(f,{ghostHtml:e})),s=$(".ghost");var n=t.offset();s.css("top",n.top-$(window).scrollTop()+t.outerHeight()),s.css("left",n.left)},p=function(){angular.element(".ghost__placeholder").removeClass("ghost__placeholder").removeAttr("width"),angular.element(".ghost__data").removeClass("ghost__data")};t.bind("mousedown",function(e){d=e.target}),t.bind("dragstart",function(e){return"undefined"!=typeof e.originalEvent.dataTransfer&&"undefined"!=typeof e.originalEvent.dataTransfer.mozSourceNode&&e.originalEvent.dataTransfer.setData("application/node type",this),!(n.handle&&!$(d).hasClass(n.handle)&&!$(d).closest(n.handle).length)&&(p(),t.addClass("ghost__placeholder").attr("width",t.outerWidth()),void c(e))}),t.bind("drag",function(e){clearTimeout(l),l=setTimeout(function(){s&&s.css("left",a-o)},5)}),t.bind("dragstop dragend",function(e){s&&s.remove(),p(),d=!1})}}}]).directive("dropMe",[function(){return{link:function(e,t,n){var a=!1,r=function(e,n){var a=angular.element(".ghost__placeholder").last(),r=angular.element("tbody td:nth-child("+n+")"),i=angular.element(".ghost__data"),o=r.length;if("right"===e){t.after(a);for(var l=0;l<o&&"undefined"!=typeof i[l];l++)$(r[l]).after(i[l])}else if("left"===e){t.before(a);for(var d=0;d<o&&"undefined"!=typeof i[d];d++)$(r[d]).before(i[d])}};t.bind("dragover",function(e){e.preventDefault(),clearTimeout(a),a=setTimeout(function(){var n=e.originalEvent.x>t.offset().left+t.width()/2?"right":"left";r(n,t.index()+1)},5)})}}}]);