angular.module("Dragtable",[]).directive("dragMe",[function(){return{link:function(e,t,n){t.attr("draggable",!0),n.handle&&t.find(n.handle)?t.find(n.handle).attr("style","cursor: e-resize;"):t.attr("style","cursor: e-resize;");var i,r,a=n.limit||50,o=0,l=!1,d=!1,s=!1,f='<div class="ghost" style="position: fixed;">{ghostHtml}</div>',h='<div class="{elemClass}" style="height: {height}px; width: {width}px;">{text}</div>';$(document).on("dragover",function(e){i=e.originalEvent.clientX,r=e.originalEvent.clientY});var u=function(e,t){for(var n in t)e=e.replace(new RegExp("{"+n+"}","g"),t[n]);return e},g=function(e){o=e.originalEvent.clientX-t.offset().left},c=function(e){s&&s.remove(),g(e),m(v())},v=function(){var e="",n=t.index()+1,i=t.closest("table").find("tr td:nth-child("+n+"):visible");i.addClass("ghost__data");var r=i.length;r>a&&(r=a);for(var o=0;o<r;o++){var l=$(i[o]);e+=u(h,{elemClass:"ghost__td",height:l.outerHeight(),width:l.outerWidth(),text:l.html()})}return e},m=function(e){t.closest("table").before(u(f,{ghostHtml:e})),s=$(".ghost");var n=t.offset();s.css("top",n.top-$(window).scrollTop()+t.outerHeight()),s.css("left",n.left)},p=function(){angular.element(".ghost__placeholder").removeClass("ghost__placeholder").removeAttr("width"),angular.element(".ghost__data").removeClass("ghost__data")};t.bind("mousedown",function(e){d=e.target}),t.bind("dragstart",function(e){return"undefined"!=typeof e.originalEvent.dataTransfer&&"undefined"!=typeof e.originalEvent.dataTransfer.mozSourceNode&&e.originalEvent.dataTransfer.setData("application/node type",this),!(n.handle&&!$(d).hasClass(n.handle)&&!$(d).closest(n.handle).length)&&(p(),t.addClass("ghost__placeholder").attr("width",t.outerWidth()),void c(e))}),t.bind("drag",function(e){clearTimeout(l),l=setTimeout(function(){s&&s.css("left",i-o)},5)}),t.bind("dragend",function(e){s&&s.remove(),p(),d=!1})}}}]).directive("dropMe",[function(){return{link:function(e,t,n){var i=!1,r=n.limit||50,a=!1,o=!1,l=function(e,n,i){if(e===a&&n===a)return!1;var l=angular.element(".ghost__placeholder").last(),d=angular.element("tbody td:nth-child("+n+")"),s=angular.element(".ghost__data"),f=d.length;if(f>r&&i!==!0&&(f=r),"right"===e){t.after(l);for(var h=0;h<f&&"undefined"!=typeof s[h];h++)$(d[h]).after(s[h])}else if("left"===e){t.before(l);for(var u=0;u<f&&"undefined"!=typeof s[u];u++)$(d[u]).before(s[u])}a=e,o=n};t.bind("dragover",function(e){e.preventDefault(),clearTimeout(i),i=setTimeout(function(){var n=e.originalEvent.x>t.offset().left+t.width()/2?"right":"left";l(n,t.index()+1)},50)}),t.bind("drop",function(e){var n=e.originalEvent.x>t.offset().left+t.width()/2?"right":"left";l(n,t.index()+1,!0)})}}}]);